# ุฅุตูุงุญ ุฎุทุฃ ูููุฏ ูุงุนุฏุฉ ุงูุจูุงูุงุช ูู ูุธุงู ุงููุญุงูุธ ุงููุฒุฏูุฌุฉ

## ูุธุฑุฉ ุนุงูุฉ
ุชู ุฅุตูุงุญ ุฎุทุฃ ุญุฑุฌ ูู ูุธุงู ุงูุฏูุน ุงูุฅููุชุฑููู ูุงู ูููุน ุฅุชูุงู ุนูููุงุช ุงุนุชูุงุฏ ุงูุฏูุนุงุช ุจูุฌุงุญ.

## ุชูุงุตูู ุงููุดููุฉ

### **ุงูุฎุทุฃ ุงูุฃุตูู:**
```
PostgrestException(message: Dual wallet transaction failed: duplicate key value violates unique constraint "wallets_user_id_key", code: P0001, details: Bad Request, hint: null)
```

### **ุงูุณุจุจ ุงูุฌุฐุฑู:**
- ุฌุฏูู `wallets` ูุงู ูุญุชูู ุนูู ููุฏ ูุฑูุฏ `UNIQUE(user_id)` 
- ุงููุธุงู ูุงู ูุญุงูู ุฅูุดุงุก ูุญุงูุธ ูุชุนุฏุฏุฉ ูููุณ ุงููุณุชุฎุฏู (ูุญูุธุฉ ุดุฎุตูุฉ + ูุญูุธุฉ ุฃุนูุงู)
- ูุธููุฉ ุฅูุดุงุก ูุญูุธุฉ ุงูุดุฑูุฉ ูุงูุช ุชุญุงูู ุฅูุดุงุก ูุญูุธุฉ ุจู `user_id` ููุฌูุฏ ุจุงููุนู

### **ุงูุณููุงุฑูู ุงููุญุฏุฏ:**
- ูุนุฑู ุงูุฏูุนุฉ: `c0c851f5-ad62-479a-b6ce-a9bc44f7d2ca`
- ูุนุฑู ุงูุนููู: `aaaaf98e-f3aa-489d-9586-573332ff6301`
- ูุนุฑู ูุญูุธุฉ ุงูุนููู: `69fe870b-3439-4d4f-a0f3-f7c93decd79a`
- ูุจูุบ ุงูุฏูุนุฉ: 1000.0 ุฌููู ูุตุฑู
- ุฑุตูุฏ ุงูุนููู: 159800.0 ุฌููู ูุตุฑู (ูุงูู)

---

## ุงูุญููู ุงููุทุจูุฉ

### **1. ุฅุตูุงุญ ูุฎุทุท ูุงุนุฏุฉ ุงูุจูุงูุงุช**

#### **ุฃ. ุฅุฒุงูุฉ ุงูููุฏ ุงูุฅุดูุงูู:**
```sql
-- ุฅุฒุงูุฉ ุงูููุฏ ุงููุฑูุฏ ุนูู user_id ููุท
ALTER TABLE public.wallets DROP CONSTRAINT wallets_user_id_key;
ALTER TABLE public.wallets DROP CONSTRAINT wallets_user_id_unique;
```

#### **ุจ. ุฅุถุงูุฉ ููุฏ ูุฑูุจ ูุญุณู:**
```sql
-- ุฅูุดุงุก ููุฑุณ ูุฑูุฏ ุฌุฒุฆู ูุณูุญ ุจู NULL user_id ูููุญุงูุธ ุงููุธุงููุฉ
CREATE UNIQUE INDEX wallets_user_wallet_type_unique 
ON public.wallets (user_id, wallet_type) 
WHERE user_id IS NOT NULL;
```

**ุงููุฒุงูุง:**
- โ ูุณูุญ ุจูุญุงูุธ ูุชุนุฏุฏุฉ ูููุณ ุงููุณุชุฎุฏู (ุดุฎุตูุฉุ ุฃุนูุงูุ ุฅูุฎ)
- โ ูููุน ุงูุชูุฑุงุฑ ูููุณ ููุน ุงููุญูุธุฉ
- โ ูุณูุญ ุจูุญุงูุธ ูุธุงููุฉ ุจู `user_id = NULL`

### **2. ุฅุตูุงุญ ูุธููุฉ ุฅูุดุงุก ูุญูุธุฉ ุงูุดุฑูุฉ**

#### **ูุจู ุงูุฅุตูุงุญ:**
```sql
-- ูุงูุช ุชุญุงูู ุฅูุดุงุก ูุญูุธุฉ ุจู user_id ููุฌูุฏ
INSERT INTO public.wallets (user_id, wallet_type, ...)
VALUES (admin_user_id, 'business', ...);
```

#### **ุจุนุฏ ุงูุฅุตูุงุญ:**
```sql
-- ุชูุดุฆ ูุญูุธุฉ ูุธุงููุฉ ุจู NULL user_id
INSERT INTO public.wallets (user_id, wallet_type, ...)
VALUES (NULL, 'business', ...); -- ูุญูุธุฉ ูุธุงููุฉ
```

### **3. ุฅุตูุงุญ ูุธููุฉ ุฅูุดุงุก ูุญูุธุฉ ุงูุนููู**

#### **ุฅุถุงูุฉ ููุทู UPSERT:**
```sql
INSERT INTO public.wallets (...)
VALUES (...)
ON CONFLICT (user_id, wallet_type) DO UPDATE SET
    updated_at = NOW(),
    is_active = true,
    status = 'active';
```

### **4. ุชุญุณูู ูุนุงูุฌุฉ ุงูุฃุฎุทุงุก ูู Flutter**

#### **ุฃ. ุชุญุฏูุซ `_createClientWalletIfNeeded`:**
```dart
// ูุญุงููุฉ ุงุณุชุฎุฏุงู ุงููุธููุฉ ุงูุฌุฏูุฏุฉ ุฃููุงู
try {
  final result = await _supabase.rpc(
    'get_or_create_client_wallet',
    params: {'p_user_id': clientId},
  );
} catch (rpcError) {
  // ุงูุชุฑุงุฌุน ุฅูู ุงูุทุฑููุฉ ุงููุฏููุฉ ูุน upsert
  await _supabase.from('wallets').upsert({...}, onConflict: 'user_id,wallet_type');
}
```

#### **ุจ. ุชุญุณูู ุฑุณุงุฆู ุงูุฎุทุฃ:**
```dart
if (error.contains('duplicate key value violates unique constraint')) {
  if (error.contains('wallets_user_id_key')) {
    return 'ุงููุญูุธุฉ ููุฌูุฏุฉ ุจุงููุนู ููุฐุง ุงููุณุชุฎุฏู.';
  }
  return 'ุงูุจูุงูุงุช ููุฌูุฏุฉ ุจุงููุนู ูู ุงููุธุงู.';
}
```

---

## ุงููููุงุช ุงููุญุฏุซุฉ

### **ูููุงุช ูุงุนุฏุฉ ุงูุจูุงูุงุช:**
1. **`FIX_DUAL_WALLET_CONSTRAINT_VIOLATION.sql`** - ุงูุฅุตูุงุญ ุงูุดุงูู ุงูุฌุฏูุฏ
   - ุชุญููู ุงููุดููุฉ ุงูุญุงููุฉ
   - ุฅุฒุงูุฉ ุงููููุฏ ุงูุฅุดูุงููุฉ
   - ุฅูุดุงุก ูููุฏ ูุญุณูุฉ
   - ูุธุงุฆู ูุญุณูุฉ ูุฅูุดุงุก ุงููุญุงูุธ
   - ุชูุธูู ุงูุจูุงูุงุช ุงูููุฑุฑุฉ

### **ูููุงุช Flutter:**
2. **`lib/services/electronic_payment_service.dart`**
   - ุชุญุฏูุซ `_createClientWalletIfNeeded()` ูุน ูุนุงูุฌุฉ ุงููููุฏ
   - ุชุญุณูู `_getUserFriendlyErrorMessage()` ูุฑุณุงุฆู ุฃูุถุญ
   - ุฅุถุงูุฉ ููุทู ุงูุชุฑุงุฌุน ููุทุฑู ุงูุจุฏููุฉ

---

## ุฎุทูุงุช ุงูุชุทุจูู

### **1. ุชุดุบูู ุฅุตูุงุญ ูุงุนุฏุฉ ุงูุจูุงูุงุช:**
```sql
\i FIX_DUAL_WALLET_CONSTRAINT_VIOLATION.sql
```

### **2. ุฅุนุงุฏุฉ ุชุดุบูู ุงูุชุทุจูู:**
```bash
flutter clean
flutter pub get
flutter run
```

### **3. ุงุฎุชุจุงุฑ ุงููุธุงู:**
- ุฅูุดุงุก ุฏูุนุฉ ุฅููุชุฑูููุฉ ุฌุฏูุฏุฉ
- ุงุนุชูุงุฏ ุงูุฏูุนุฉ ูู ููุญุฉ ุงูุฅุฏุงุฑุฉ
- ุงูุชุญูู ูู ุนุฏู ุธููุฑ ุฎุทุฃ ุงููููุฏ
- ุงูุชุฃูุฏ ูู ุชุญุฏูุซ ุฃุฑุตุฏุฉ ุงููุญุงูุธ ุจุดูู ุตุญูุญ

---

## ุงููุชุงุฆุฌ ุงููุชููุนุฉ

### **โ ูุดุงูู ุชู ุญููุง:**
- โ ุฎุทุฃ `duplicate key value violates unique constraint "wallets_user_id_key"`
- โ ูุดู ุนูููุงุช ุงุนุชูุงุฏ ุงูุฏูุนุงุช ุงูุฅููุชุฑูููุฉ
- โ ุนุฏู ุฅููุงููุฉ ุฅูุดุงุก ูุญุงูุธ ูุชุนุฏุฏุฉ ูููุณุชุฎุฏู ุงููุงุญุฏ

### **โ ุชุญุณููุงุช ุฌุฏูุฏุฉ:**
- โ ูุธุงู ูุญุงูุธ ูุฑู ูุฏุนู ุฃููุงุน ูุชุนุฏุฏุฉ
- โ ูุญุงูุธ ูุธุงููุฉ ููุดุฑูุฉ ุจุฏูู ูุณุชุฎุฏู ูุญุฏุฏ
- โ ูุนุงูุฌุฉ ุฃุฎุทุงุก ูุญุณูุฉ ูุน ุฑุณุงุฆู ูุงุถุญุฉ
- โ ููุทู UPSERT ูุชุฌูุจ ุงูุชูุฑุงุฑ
- โ ุชูุธูู ุชููุงุฆู ููุจูุงูุงุช ุงูููุฑุฑุฉ

### **โ ุงููุธุงุฆู ุงููุญุณูุฉ:**
- โ ุงุนุชูุงุฏ ุงูุฏูุนุงุช ุงูุฅููุชุฑูููุฉ ูุนูู ุจุณูุงุณุฉ
- โ ุชุญุฏูุซ ุฃุฑุตุฏุฉ ุงููุญุงูุธ ุงููุฒุฏูุฌุฉ (ุนููู โ ุดุฑูุฉ)
- โ ุฅูุดุงุก ูุญุงูุธ ุฌุฏูุฏุฉ ุจุฏูู ุชุนุงุฑุถุงุช
- โ ุฏุนู ุงูุนููุฉ ุงููุตุฑูุฉ (EGP) ูู ุฌููุน ุงูุนูููุงุช

---

## ุงูุงุฎุชุจุงุฑุงุช ุงูููุตู ุจูุง

### **1. ุงุฎุชุจุงุฑ ุงุนุชูุงุฏ ุงูุฏูุนุฉ:**
```
1. ุฅูุดุงุก ุฏูุนุฉ ุฅููุชุฑูููุฉ ุฌุฏูุฏุฉ
2. ุงุนุชูุงุฏ ุงูุฏูุนุฉ ูู ููุญุฉ ุงูุฅุฏุงุฑุฉ
3. ุงูุชุญูู ูู ุชุญุฏูุซ ุงูุฃุฑุตุฏุฉ
4. ุงูุชุฃูุฏ ูู ุนุฏู ุธููุฑ ุฃุฎุทุงุก
```

### **2. ุงุฎุชุจุงุฑ ุฅูุดุงุก ุงููุญุงูุธ:**
```
1. ุฅูุดุงุก ูุณุชุฎุฏู ุฌุฏูุฏ
2. ุฅูุดุงุก ูุญูุธุฉ ุดุฎุตูุฉ
3. ุฅูุดุงุก ูุญูุธุฉ ุฃุนูุงู (ุฅุฐุง ูุทููุจ)
4. ุงูุชุญูู ูู ุนุฏู ุชุนุงุฑุถ ุงููููุฏ
```

### **3. ุงุฎุชุจุงุฑ ุงูุฃุฎุทุงุก:**
```
1. ูุญุงููุฉ ุฅูุดุงุก ูุญูุธุฉ ููุฑุฑุฉ
2. ุงูุชุญูู ูู ุฑุณุงุฆู ุงูุฎุทุฃ ุงููุงุถุญุฉ
3. ุงูุชุฃูุฏ ูู ุนุฏู ุชููู ุงููุธุงู
```

---

## ุงูุฎูุงุตุฉ

ุชู ุฅุตูุงุญ ุงููุดููุฉ ุงูุญุฑุฌุฉ ูู ูุธุงู ุงููุญุงูุธ ุงููุฒุฏูุฌุฉ ุจูุฌุงุญ. ุงููุธุงู ุงูุขู:

- **ูุณุชูุฑ**: ูุง ุชูุฌุฏ ุฃุฎุทุงุก ูููุฏ ูุงุนุฏุฉ ุงูุจูุงูุงุช
- **ูุฑู**: ูุฏุนู ุฃููุงุน ูุญุงูุธ ูุชุนุฏุฏุฉ ูููุณ ุงููุณุชุฎุฏู  
- **ุขูู**: ูุนุงูุฌุฉ ุฃุฎุทุงุก ุดุงููุฉ ูุฑุณุงุฆู ูุงุถุญุฉ
- **ูุนุงู**: ุนูููุงุช ุฏูุน ุณุฑูุนุฉ ูููุซููุฉ

ุงููุธุงู ุฌุงูุฒ ููุงุณุชุฎุฏุงู ุงูุฅูุชุงุฌู ูุน ุฏุนู ูุงูู ููุฏูุนุงุช ุงูุฅููุชุฑูููุฉ ุจุงูุฌููู ุงููุตุฑู! ๐
