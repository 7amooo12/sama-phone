# تحسين عرض تفاصيل الطلبيات في لوحة تحكم العامل

## نظرة عامة

تم تطبيق تحسين جديد على صفحة لوحة تحكم العامل لعرض تفاصيل المنتجات والكميات المطلوبة عندما تكون المهمة المسندة مرتبطة بطلبية عميل.

## الميزات الجديدة

### 1. ربط المهام بالطلبيات
- إضافة حقل `orderId` إلى نموذج `WorkerTaskModel`
- ربط المهام بالطلبيات من خلال معرف الطلبية
- دعم المهام غير المرتبطة بطلبيات (مثل مهام الصيانة)

### 2. خدمة جلب تفاصيل الطلبيات
- **الملف:** `lib/services/worker_order_service.dart`
- جلب تفاصيل الطلبيات من مصادر متعددة:
  - Supabase Orders Service
  - Stock Warehouse API
- تحويل البيانات بين التنسيقات المختلفة
- معالجة الأخطاء والحالات الاستثنائية

### 3. واجهة عرض المنتجات
- **الملف:** `lib/widgets/worker/order_products_widget.dart`
- عرض قائمة المنتجات والكميات المطلوبة
- تصميم متسق مع باقي عناصر الواجهة
- حالات مختلفة للعرض:
  - حالة التحميل
  - حالة الخطأ مع إمكانية إعادة المحاولة
  - حالة عدم وجود منتجات
  - عرض قائمة المنتجات

### 4. تحديث واجهة لوحة تحكم العامل
- **الملف:** `lib/screens/worker/worker_dashboard_screen.dart`
- إضافة قسم "تفاصيل الطلبية" في متطلبات المهمة
- عرض تلقائي لتفاصيل الطلبية عند وجود `orderId`
- تكامل سلس مع التصميم الحالي

## البنية التقنية

### نموذج البيانات
```dart
class WorkerTaskModel {
  final String? orderId; // معرف الطلبية المرتبطة بالمهمة
  // باقي الحقول...
}
```

### خدمة الطلبيات
```dart
class WorkerOrderService {
  // جلب تفاصيل طلبية محددة
  Future<OrderModel?> getOrderDetails(String orderId);
  
  // جلب قائمة المنتجات والكميات
  Future<List<Map<String, dynamic>>> getOrderProductsAndQuantities(String orderId);
  
  // التحقق من وجود طلبية
  Future<bool> orderExists(String orderId);
}
```

### واجهة عرض المنتجات
```dart
class OrderProductsWidget extends StatefulWidget {
  final String orderId;
  // عرض المنتجات والكميات بتصميم احترافي
}
```

## كيفية الاستخدام

### 1. إنشاء مهمة مرتبطة بطلبية
```dart
final task = WorkerTaskModel(
  id: 'task_1',
  title: 'تحضير طلبية العميل أحمد',
  description: 'تحضير وتجهيز المنتجات للطلبية',
  assignedTo: 'worker_1',
  priority: TaskPriority.high,
  status: TaskStatus.assigned,
  createdAt: DateTime.now(),
  updatedAt: DateTime.now(),
  category: 'طلبيات',
  orderId: '12345', // معرف الطلبية
);
```

### 2. عرض تفاصيل الطلبية
عند وجود `orderId` في المهمة، ستظهر تلقائياً تفاصيل الطلبية في قسم "متطلبات المهمة" تتضمن:
- قائمة المنتجات
- الكميات المطلوبة لكل منتج
- أسعار المنتجات
- أوصاف المنتجات (إن وجدت)

### 3. معالجة الأخطاء
- عرض رسائل خطأ واضحة عند فشل تحميل البيانات
- إمكانية إعادة المحاولة
- عرض حالة فارغة عند عدم وجود منتجات

## الفوائد

### للعمال
- رؤية واضحة لتفاصيل المنتجات المطلوبة
- معرفة الكميات المحددة لكل منتج
- تحسين كفاءة العمل وتقليل الأخطاء
- واجهة سهلة الاستخدام ومتسقة

### للإدارة
- ربط أفضل بين المهام والطلبيات
- تتبع أدق لتنفيذ الطلبيات
- تقليل الأخطاء في التحضير
- تحسين رضا العملاء

## الاختبارات

تم إنشاء مجموعة شاملة من الاختبارات في `test_worker_order_integration.dart`:
- اختبار إنشاء المهام مع معرف الطلبية
- اختبار تحويل البيانات من وإلى JSON
- اختبار واجهة عرض المنتجات
- اختبار خدمة الطلبيات
- اختبار معالجة الحالات الاستثنائية

## التوافق

- متوافق مع النظام الحالي للمهام
- يدعم المهام المرتبطة وغير المرتبطة بالطلبيات
- متوافق مع مصادر البيانات المختلفة
- تصميم متجاوب يعمل على جميع أحجام الشاشات

## المتطلبات التقنية

### التبعيات المطلوبة
- `flutter/material.dart`
- `google_fonts`
- `provider`
- خدمات API الموجودة

### قاعدة البيانات
يجب التأكد من وجود حقل `order_id` في جدول `worker_tasks`:
```sql
ALTER TABLE worker_tasks ADD COLUMN order_id TEXT;
```

## الصيانة والتطوير المستقبلي

### تحسينات مقترحة
- إضافة إشعارات عند تحديث تفاصيل الطلبية
- دعم الصور للمنتجات
- إضافة فلترة وبحث في المنتجات
- تحسين الأداء مع التخزين المؤقت

### نقاط المراقبة
- أداء تحميل تفاصيل الطلبيات
- معدل نجاح جلب البيانات من APIs
- استخدام الذاكرة عند عرض قوائم طويلة من المنتجات
- تجربة المستخدم على الأجهزة المختلفة

## الدعم

للحصول على المساعدة أو الإبلاغ عن مشاكل:
1. مراجعة ملفات الاختبار للأمثلة
2. فحص سجلات التطبيق للأخطاء
3. التأكد من صحة معرفات الطلبيات
4. التحقق من اتصال الشبكة وتوفر APIs
